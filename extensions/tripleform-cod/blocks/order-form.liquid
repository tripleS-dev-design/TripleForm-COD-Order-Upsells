{% comment %}
Tripleform COD ‚Äì App block (product template)

Lit la config form depuis:
- product.metafields.tripleform_cod.settings (prioritaire)
- shop.metafields.tripleform_cod.settings (fallback)

Lit la config OFFRES / UPSELL depuis:
- product.metafields.tripleform_cod.offers (prioritaire)
- shop.metafields.tripleform_cod.offers (fallback)

reCAPTCHA v3 (SCALABLE):
- lit la Site Key depuis shop.metafields.tripleform_cod.recaptcha_site_key
- injecte automatiquement:
  - window.TF_RECAPTCHA_SITE_KEY
  - script https://www.google.com/recaptcha/api.js?render=SITE_KEY
- passe aussi la cl√© au JS via data-recaptcha-site-key
{% endcomment %}

{%- assign tf_prod_val = product.metafields.tripleform_cod.settings.value -%}
{%- assign tf_shop_val = shop.metafields.tripleform_cod.settings.value -%}

{%- comment -%} reCAPTCHA site key (public) depuis metafield shop {%- endcomment -%}
{%- assign tf_recaptcha_site_key = shop.metafields.tripleform_cod.recaptcha_site_key.value -%}

{%- if tf_prod_val and tf_prod_val != blank -%}
  {%- assign tf_json = tf_prod_val -%}
{%- elsif tf_shop_val and tf_shop_val != blank -%}
  {%- assign tf_json = tf_shop_val -%}
{%- else -%}
  {%- comment -%}D√©terminer le pays et les valeurs par d√©faut bas√©es sur la boutique{%- endcomment -%}
  {%- assign shop_country_code = shop.country_code | default: 'MA' -%}

  {%- comment -%}D√©terminer le pr√©fixe t√©l√©phonique et les labels bas√©s sur le pays{%- endcomment -%}
  {%- assign phone_prefix = '+212' -%}

  {%- assign province_label = 'Province' -%}
  {%- assign province_placeholder = 'Select province' -%}

  {%- assign city_label = 'City' -%}
  {%- assign city_placeholder = 'Select city' -%}

  {%- case shop_country_code -%}
    {%- when 'MA' -%}
      {%- assign phone_prefix = '+212' -%}
      {%- assign province_label = 'Province' -%}
      {%- assign province_placeholder = 'Select province' -%}
      {%- assign city_label = 'Ville' -%}
      {%- assign city_placeholder = 'Choisir une ville' -%}
    {%- when 'DZ' -%}
      {%- assign phone_prefix = '+213' -%}
      {%- assign province_label = 'Wilaya' -%}
      {%- assign province_placeholder = 'Select wilaya' -%}
      {%- assign city_label = 'Commune' -%}
      {%- assign city_placeholder = 'Choisir une commune' -%}
    {%- when 'TN' -%}
      {%- assign phone_prefix = '+216' -%}
      {%- assign province_label = 'Gouvernorat' -%}
      {%- assign province_placeholder = 'Select gouvernorat' -%}
      {%- assign city_label = 'Ville' -%}
      {%- assign city_placeholder = 'Choisir une ville' -%}
    {%- when 'EG' -%}
      {%- assign phone_prefix = '+20' -%}
      {%- assign province_label = 'Governorate' -%}
      {%- assign province_placeholder = 'Select governorate' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'FR' -%}
      {%- assign phone_prefix = '+33' -%}
      {%- assign province_label = 'R√©gion' -%}
      {%- assign province_placeholder = 'Select region' -%}
      {%- assign city_label = 'Ville' -%}
      {%- assign city_placeholder = 'Choisir une ville' -%}
    {%- when 'ES' -%}
      {%- assign phone_prefix = '+34' -%}
      {%- assign province_label = 'Provincia' -%}
      {%- assign province_placeholder = 'Select provincia' -%}
      {%- assign city_label = 'Ciudad' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'SA' -%}
      {%- assign phone_prefix = '+966' -%}
      {%- assign province_label = 'Province' -%}
      {%- assign province_placeholder = 'Select province' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'AE' -%}
      {%- assign phone_prefix = '+971' -%}
      {%- assign province_label = 'Emirate' -%}
      {%- assign province_placeholder = 'Select emirate' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'US' -%}
      {%- assign phone_prefix = '+1' -%}
      {%- assign province_label = 'State' -%}
      {%- assign province_placeholder = 'Select state' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'NG' -%}
      {%- assign phone_prefix = '+234' -%}
      {%- assign province_label = 'State' -%}
      {%- assign province_placeholder = 'Select state' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'PK' -%}
      {%- assign phone_prefix = '+92' -%}
      {%- assign province_label = 'Province' -%}
      {%- assign province_placeholder = 'Select province' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'IN' -%}
      {%- assign phone_prefix = '+91' -%}
      {%- assign province_label = 'State' -%}
      {%- assign province_placeholder = 'Select state' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'ID' -%}
      {%- assign phone_prefix = '+62' -%}
      {%- assign province_label = 'Province' -%}
      {%- assign province_placeholder = 'Select province' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'TR' -%}
      {%- assign phone_prefix = '+90' -%}
      {%- assign province_label = 'Province' -%}
      {%- assign province_placeholder = 'Select province' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- when 'BR' -%}
      {%- assign phone_prefix = '+55' -%}
      {%- assign province_label = 'State' -%}
      {%- assign province_placeholder = 'Select state' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
    {%- else -%}
      {%- assign phone_prefix = '+212' -%}
      {%- assign province_label = 'Province' -%}
      {%- assign province_placeholder = 'Select province' -%}
      {%- assign city_label = 'City' -%}
      {%- assign city_placeholder = 'Select city' -%}
  {%- endcase -%}

  {%- capture tf_json -%}
  {
    "meta": {
      "version": 1,
      "preset": "CleanWhite",
      "fieldsOrder": ["name","phone","quantity","address","city","province","notes"]
    },
    "form": {
      "style": "inline",
      "title": "Order form",
      "subtitle": "Please enter your contact information",
      "buttonText": "Order now",
      "successText": "Thanks! We'll contact you",
      "buttonIcon": "CartIcon"
    },
    "thankyou": {
      "enabled": true,
      "mode": "popup",
      "title": "Thank you!",
      "text": "Your order has been received. We will contact you soon.",
      "primaryLabel": "Continue shopping",
      "primaryUrl": "/",
      "secondaryLabel": "Close",
      "secondaryAction": "close",
      "autoCloseMs": 0
    },
    "design": {
      "bg": "#FFFFFF",
      "text": "#0F172A",
      "border": "#E5E7EB",
      "radius": 12,
      "padding": 16,
      "inputBg": "#FFFFFF",
      "inputBorder": "#E5E7EB",
      "placeholder": "#94A3B8",
      "btnBg": "#111827",
      "btnText": "#FFFFFF",
      "btnBorder": "#111827",
      "btnHeight": 46,
      "btnRadius": 10,
      "shadow": true,
      "glow": false,
      "glowPx": 18,
      "cartBg": "#FFFFFF",
      "cartBorder": "#E5E7EB",
      "cartRowBg": "#FFFFFF",
      "cartRowBorder": "#E5E7EB",
      "cartTitleColor": "#0F172A",
      "cartTextColor": "#0F172A",
      "direction": "ltr",
      "fontSize": 14,
      "titleAlign": "left",
      "fieldAlign": "left"
    },
    "behavior": {
      "requireGDPR": false,
      "gdprLabel": "I accept the privacy policy",
      "whatsappOptIn": false,
      "whatsappLabel": "Receive confirmation on WhatsApp",
      "openDelayMs": 0,
      "closeOnOutside": true,
      "effect": "none",
      "buttonMotion": "none",
      "stickyType": "none",
      "stickyLabel": "Order now",
      "stickyIcon": "CartIcon",
      "drawerDirection": "right",
      "drawerSize": "md",
      "overlayColor": "#020617",
      "overlayOpacity": 70,
      "country": "{{ shop_country_code }}",
      "codCountry": "{{ shop_country_code }}",
      "provinceKey": "",
      "cityKey": ""
    },
    "fields": {
      "name": {
        "on": true,
        "required": true,
        "type": "text",
        "label": "Full name",
        "ph": "Your full name",
        "icon": "ProfileIcon"
      },
      "phone": {
        "on": true,
        "required": true,
        "type": "tel",
        "label": "Phone (WhatsApp)",
        "ph": "Phone number",
        "prefix": "{{ phone_prefix }}",
        "icon": "PhoneIcon"
      },
      "quantity": {
        "on": true,
        "required": true,
        "type": "number",
        "label": "Quantity",
        "ph": "1",
        "min": 1,
        "max": 10,
        "icon": "HashtagIcon"
      },
      "province": {
        "on": true,
        "required": false,
        "type": "select",
        "label": "{{ province_label }}",
        "ph": "{{ province_placeholder }}",
        "icon": "RegionIcon"
      },
      "city": {
        "on": true,
        "required": false,
        "type": "select",
        "label": "{{ city_label }}",
        "ph": "{{ city_placeholder }}",
        "icon": "CityIcon"
      },
      "address": {
        "on": false,
        "required": false,
        "type": "text",
        "label": "Address",
        "ph": "Full address",
        "icon": "LocationIcon"
      },
      "notes": {
        "on": false,
        "required": false,
        "type": "textarea",
        "label": "Notes",
        "ph": "(optional)",
        "icon": "NoteIcon"
      }
    },
    "cartTitles": {
      "top": "Order summary",
      "price": "Product price",
      "shipping": "Shipping price",
      "total": "Total",
      "shippingToCalculate": "Livraison √† calculer",
      "cartIcon": "CartIcon"
    },
    "uiTitles": {
      "applyCoupon": "Apply",
      "orderNow": "Order now",
      "totalSuffix": "Total:"
    }
  }
  {%- endcapture -%}
{%- endif -%}

{%- comment %}
OFFRES / UPSELL
Ces donn√©es sont √©crites par /api/save-offers dans:
- product.metafields.tripleform_cod.offers (prioritaire)
- shop.metafields.tripleform_cod.offers (fallback)
{%- endcomment -%}

{%- assign tf_offers_prod_val = product.metafields.tripleform_cod.offers.value -%}
{%- assign tf_offers_shop_val = shop.metafields.tripleform_cod.offers.value -%}

{%- if tf_offers_prod_val and tf_offers_prod_val != blank -%}
  {%- assign tf_offers_json = tf_offers_prod_val -%}
{%- elsif tf_offers_shop_val and tf_offers_shop_val != blank -%}
  {%- assign tf_offers_json = tf_offers_shop_val -%}
{%- else -%}
  {%- capture tf_offers_json -%}
  {
    "meta": { "version": 10 },
    "global": {
      "enabled": true,
      "currency": "{{ shop.currency | default: 'MAD' }}",
      "rounding": "none",
      "colorPalette": "blue-gradient"
    },
    "offers": [
      {
        "enabled": true,
        "title": "Remise sp√©ciale -10%",
        "description": "Profitez de -10% sur votre premi√®re commande",
        "showInPreview": true,
        "enableTimer": true,
        "timerMinutes": 60,
        "timerMessage": "‚è±Ô∏è Offre limit√©e!",
        "timerCssClass": "timer-flash",
        "timerTimeFormat": "mm:ss",
        "discountType": "percentage",
        "discountValue": 10,
        "conditions": {
          "minAmount": 0,
          "maxUses": 100,
          "applicableTo": "all"
        },
        "buttonText": "Activer",
        "imageUrl": "",
        "currency": "{{ shop.currency | default: 'MAD' }}"
      }
    ],
    "upsells": [
      {
        "enabled": true,
        "title": "Cadeau gratuit inclus!",
        "description": "Recevez un accessoire en cadeau avec votre commande",
        "showInPreview": true,
        "enableTimer": true,
        "timerMinutes": 45,
        "timerMessage": "üéÅ Cadeau limit√©!",
        "timerCssClass": "timer-hot",
        "timerTimeFormat": "hh[h] mm[m]",
        "giftProductId": "",
        "giftVariantId": "",
        "giftTitle": "Accessoire gratuit",
        "imageUrl": ""
      }
    ],
    "display": {
      "showOrderSummary": true,
      "showOffersSection": true,
      "showTimerInPreview": true,
      "showActivationButtons": true
    }
  }
  {%- endcapture -%}
{%- endif -%}

{%- assign current_variant = product.selected_or_first_available_variant -%}

{%- comment -%}
‚úÖ reCAPTCHA auto-inject (SCALABLE)
- Seulement si la Site Key existe dans le shop metafield
- Pas besoin que l'utilisateur modifie le th√®me manuellement
{%- endcomment -%}
{% if tf_recaptcha_site_key != blank %}
  <script>
    window.TF_RECAPTCHA_SITE_KEY = {{ tf_recaptcha_site_key | json }};
  </script>
  <script src="https://www.google.com/recaptcha/api.js?render={{ tf_recaptcha_site_key }}"></script>
{% endif %}

<div
  id="tripleform-cod-{{ section.id }}"
  class="tripleform-cod"
  data-settings='{% if tf_prod_val and tf_prod_val != blank or tf_shop_val and tf_shop_val != blank %}{{ tf_json | json | escape }}{% else %}{{ tf_json | strip | escape }}{% endif %}'
  data-offers='{% if tf_offers_prod_val and tf_offers_prod_val != blank or tf_offers_shop_val and tf_offers_shop_val != blank %}{{ tf_offers_json | json | escape }}{% else %}{{ tf_offers_json | strip | escape }}{% endif %}'
  data-product-id='{{ product.id }}'
  data-variant-id='{{ current_variant.id }}'
  data-currency='{{ cart.currency.iso_code | default: shop.currency }}'
  data-locale='{{ request.locale.iso_code }}'
  data-recaptcha-site-key='{{ tf_recaptcha_site_key | escape }}'

  {%- comment -%}
    GEO / SHIPPING
    - active le calcul de livraison via app proxy
    - country = pays boutique (MA / DZ / TN‚Ä¶)
    - endpoint = route proxy `proxy.api.geo.calc.jsx`
  {%- endcomment -%}
  data-geo-enabled="true"
  data-geo-country="{{ shop.country_code | default: 'MA' }}"
  data-geo-endpoint="/apps/tripleform-cod/api/geo/calc"
>
  <noscript>Enable JavaScript to use the COD form.</noscript>
  <div style="font:14px/1.4 system-ui, sans-serif; color:#6b7280">
    Loading COD form‚Ä¶
  </div>
</div>

<script type="application/json" id="tf-product-json-{{ section.id }}">
  {{ product | json }}
</script>

<script>
  (function () {
    function boot() {
      if (window.TripleformCOD && typeof window.TripleformCOD.boot === 'function') {
        window.TripleformCOD.boot('{{ section.id }}');
      }
    }
    document.addEventListener('DOMContentLoaded', boot);
    document.addEventListener('shopify:section:load', boot);
    document.addEventListener('shopify:section:select', boot);
    document.addEventListener('shopify:block:select', boot);
  })();
</script>

{% schema %}
{
  "name": "Tripleform COD form",
  "target": "section",
  "enabled_on": { "templates": ["product"] },
  "stylesheet": "tripleform-cod.css",
  "javascript": "tripleform.js",
  "settings": [
    {
      "type": "text",
      "id": "note",
      "label": "Note (facultatif c√¥t√© th√®me)",
      "default": "Tripleform COD"
    }
  ]
}
{% endschema %}
